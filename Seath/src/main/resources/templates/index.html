<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SEATH - Sistema de Análise</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- CSS do Choices.js carregado globalmente -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .form-label .form-switch { margin-bottom: -0.3rem; }
        .actions a:not(:last-child) { margin-right: 0.5rem; }
        .pregao-item { cursor: pointer; }
        .choices__input--cloned { display: none !important; }
    </style>
</head>
<body class="bg-light">

<div class="container-fluid mt-4">

    <header class="text-center mb-4">
        <h1>SEATH</h1>
        <p class="lead">Sistema de Engenharia para Análise, Testagem e Hospedagem</p>
    </header>

    <div class="row align-items-stretch">
        <!-- Coluna do Menu -->
        <div class="col-lg-2 d-flex">
            <div class="card shadow-sm mb-5 w-100">
                <div class="card-header"><h4 class="my-1">Menu</h4></div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action" data-hx-get="/view/cadastrar" data-hx-target="#main-content" data-hx-swap="innerHTML">Cadastrar Ficha</a>
                        <a href="#" class="list-group-item list-group-item-action" data-hx-get="/view/listar" data-hx-target="#main-content" data-hx-swap="innerHTML">Itens Cadastrados</a>
                        <a href="#" class="list-group-item list-group-item-action" data-hx-get="/view/empresas" data-hx-target="#main-content" data-hx-swap="innerHTML">Gerenciar Empresas</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coluna de Conteúdo Principal -->
        <div class="col-lg-10 d-flex">
            <div id="main-content" class="w-100" data-hx-get="/view/cadastrar" data-hx-trigger="load" data-hx-swap="innerHTML">
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts Globais -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<!-- Script de Inicialização -->
<script>
    // Variáveis globais para as instâncias do Choices
    let choicesPregao, choicesNomePregao, choicesProcesso;

    // Funções auxiliares
    function isPregaoGroupLocked() { const groupSwitch = document.getElementById('lockPregaoGroup'); return groupSwitch && groupSwitch.checked; }
    function preencherFormulario(numero, processo, descricao) { if (!isPregaoGroupLocked()) { choicesPregao.setChoiceByValue(String(numero || '')); choicesProcesso.setChoiceByValue(String(processo || '')); choicesNomePregao.setChoiceByValue(String(descricao || '')); } }
    function isLocked(elementId) { if (!elementId) return false; const switchEl = document.querySelector(`.lock-switch[data-lock-target="${elementId}"]`); return switchEl && switchEl.checked; }

    // Função principal que inicializa os scripts para o formulário de cadastro
    function initCadastroScripts() {
        const choicesConfig = { searchPlaceholderValue: "Pesquisar...", removeItemButton: true, itemSelectText: 'Pressione para selecionar', noResultsText: 'Nenhum resultado encontrado', noChoicesText: 'Sem opções para escolher', addItemFilter: () => false, searchEnabled: true, searchFloor: 1 };
        choicesPregao = new Choices('#pregao', choicesConfig);
        choicesNomePregao = new Choices('#nomePregao', choicesConfig);
        choicesProcesso = new Choices('#processo', choicesConfig);
        
        const setupListener = (elementId, findOption, fillFunction) => {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.addEventListener('change', (event) => { if (isPregaoGroupLocked()) return; const selectedValue = event.detail.value; if (selectedValue && selectedValue !== "") { const option = findOption(selectedValue); if (option) fillFunction(option, selectedValue); } else { preencherFormulario('', '', ''); } });
        };
        setupListener('pregao', (val) => document.querySelector(`#pregao option[value="${val}"]`), (opt, val) => preencherFormulario(val, opt.getAttribute('data-processo'), opt.getAttribute('data-descricao')));
        setupListener('nomePregao', (val) => document.querySelector(`#nomePregao option[value="${val}"]`), (opt, val) => preencherFormulario(opt.getAttribute('data-nome'), opt.getAttribute('data-processo'), val));
        setupListener('processo', (val) => document.querySelector(`#processo option[value="${val}"]`), (opt, val) => preencherFormulario(opt.getAttribute('data-nome'), val, opt.getAttribute('data-descricao')));

        const lockedFieldsJSON = sessionStorage.getItem('lockedFields');
        if (lockedFieldsJSON) { const lockedFields = JSON.parse(lockedFieldsJSON); if (lockedFields.lockPregaoGroup) { document.getElementById('lockPregaoGroup').checked = true; choicesPregao.setChoiceByValue(lockedFields.pregao || ''); choicesNomePregao.setChoiceByValue(lockedFields.nomePregao || ''); choicesProcesso.setChoiceByValue(lockedFields.processo || ''); } document.querySelectorAll('.lock-switch').forEach(switchEl => { const targetId = switchEl.dataset.lockTarget; if (lockedFields[targetId]) { document.getElementById(targetId).value = lockedFields[targetId]; switchEl.checked = true; } }); }
        
        const form = document.getElementById('fichaForm');
        form.addEventListener('submit', function() { const lockedFields = {}; if (isPregaoGroupLocked()) { lockedFields.lockPregaoGroup = true; lockedFields.pregao = document.getElementById('pregao').value; lockedFields.nomePregao = document.getElementById('nomePregao').value; lockedFields.processo = document.getElementById('processo').value; } document.querySelectorAll('.lock-switch:checked').forEach(switchEl => { const targetId = switchEl.dataset.lockTarget; const element = document.getElementById(targetId); if (element) { lockedFields[targetId] = element.value; } }); sessionStorage.setItem('lockedFields', JSON.stringify(lockedFields)); });
        
        document.getElementById('searchPregao').addEventListener('input', function(event) { const searchTerm = event.target.value.toLowerCase(); const items = document.querySelectorAll('#pregao-list-container .pregao-item'); const noResultsMessage = document.getElementById('no-results-message'); const noPregaoMessage = document.getElementById('no-pregao-message'); let visibleCount = 0; items.forEach((item, index) => { const nome = item.getAttribute('data-nome').toLowerCase(); const processo = item.getAttribute('data-processo').toLowerCase(); const descricao = item.getAttribute('data-descricao').toLowerCase(); const matchesSearch = nome.includes(searchTerm) || processo.includes(searchTerm) || descricao.includes(searchTerm); if (searchTerm === '') { item.style.display = index < 5 ? '' : 'none'; visibleCount = items.length > 5 ? 5 : items.length; } else { if (matchesSearch) { item.style.display = ''; visibleCount++; } else { item.style.display = 'none'; } } }); if (noResultsMessage) { noResultsMessage.style.display = (visibleCount === 0 && searchTerm !== '') ? 'block' : 'none'; } if (noPregaoMessage) { noPregaoMessage.style.display = (items.length === 0) ? 'block' : 'none'; } });
    }

    // Função que inicializa os scripts para a página de empresas
    function initEmpresasScripts() {
        document.getElementById('searchEmpresa').addEventListener('input', function(event) { const searchTerm = event.target.value.toLowerCase(); const items = document.querySelectorAll('#empresa-list-container .list-group-item'); const noResultsMessage = document.getElementById('no-results-message'); let visibleCount = 0; items.forEach(item => { const itemText = item.textContent.toLowerCase(); if (itemText.includes(searchTerm)) { item.style.display = ''; visibleCount++; } else { item.style.display = 'none'; } }); noResultsMessage.style.display = (visibleCount === 0 && items.length > 0) ? 'block' : 'none'; });
    }

    // Evento principal do HTMX: é disparado DEPOIS que um fragmento é carregado
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'main-content') {
            // Se o conteúdo carregado tem o formulário de fichas, inicializa seus scripts
            if (event.detail.target.querySelector('#fichaForm')) {
                initCadastroScripts();
            }
            // Se o conteúdo carregado tem o formulário de empresas, inicializa seus scripts
            if (event.detail.target.querySelector('#empresaForm')) {
                initEmpresasScripts();
            }
        }
    });
</script>

</body>
</html>