<!DOCTYPE html>
<html lang="pt-br">
<body>

<!-- CSS Necessário para o Choices (Plugins JS) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

<div data-th-fragment="conteudoCadastro" id="cadastro-container">

    <div class="row align-items-stretch">
        
        <!-- ============================= -->
        <!--  COLUNA ESQUERDA: FORMULÁRIO  -->
        <!-- ============================= -->
        <div class="col-lg-9 d-flex">
            <div class="card shadow-sm mb-5 w-100">
                <div class="card-header bg-primary text-white">
                    <h4 class="my-1"><i class="bi bi-file-earmark-text"></i> Cadastrar Nova Ficha</h4>
                </div>
                <div class="card-body">
                    
                    <form id="fichaForm" data-th-action="@{/fichas/salvar}" data-th-object="${fichaForm}" method="post">
                        
                        <!-- Switch Geral -->
                        <div class="alert alert-light border d-flex align-items-center p-2 mb-3">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" role="switch" id="lockPregaoGroup">
                                <label class="form-check-label fw-bold ms-2" for="lockPregaoGroup">Travar Cabeçalho (Pregão, Processo e Nome)</label>
                            </div>
                        </div>

                        <div class="row g-3">
                            <!-- Cabeçalho -->
                            <div class="col-md-4">
                                <label class="form-label text-muted small mb-1">Nº do Pregão</label>
                                <input type="text" id="pregao" data-th-field="*{pregao}" class="form-control bg-light fw-bold" readonly placeholder="<- Selecione na lista"/>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted small mb-1">Nome do Pregão</label>
                                <input type="text" id="nomePregao" data-th-field="*{nomePregao}" class="form-control bg-light" readonly/>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted small mb-1">Processo</label>
                                <input type="text" id="processo" data-th-field="*{processo}" class="form-control bg-light" readonly/>
                            </div>

                            <div class="col-12"><hr class="my-2 text-muted"></div>

                            <!-- Linha 1: Item e Descrição -->
                            <div class="col-md-2">
                                <label for="item" class="form-label mb-1">Item</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="item"></div>
                                    <input type="text" id="item" data-th-field="*{item}" class="form-control"/>
                                </div>
                            </div>
                            <div class="col-md-10">
                                <label for="infoProduto" class="form-label mb-1">Descrição do Produto</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="infoProduto"></div>
                                    <input type="text" id="infoProduto" data-th-field="*{infoProduto}" class="form-control" placeholder="Ex: Cimento CP-II 50kg"/>
                                </div>
                            </div>

                            <!-- Linha 2: Licitante e Marca -->
                            <div class="col-md-8">
                                <label for="licitante" class="form-label mb-1">Licitante / Empresa</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="licitante"></div>
                                    <input type="text" id="licitante" data-th-field="*{licitante}" class="form-control bg-white" readonly onclick="document.getElementById('searchEmpresa').focus()" placeholder="Selecione na lista lateral ->"/>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="marca" class="form-label mb-1">Marca</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="marca"></div>
                                    <input type="text" id="marca" data-th-field="*{marca}" class="form-control"/>
                                </div>
                            </div>

                            <!-- Linha 3: Detalhes 4x3 -->
                            <div class="col-md-3">
                                <label for="modelo" class="form-label mb-1">Modelo</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="modelo"></div>
                                    <input type="text" id="modelo" data-th-field="*{modelo}" class="form-control"/>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="material" class="form-label mb-1">Material</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="material"></div>
                                    <input type="text" id="material" data-th-field="*{material}" class="form-control"/>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="tamanho" class="form-label mb-1">Tamanho</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="tamanho"></div>
                                    <input type="text" id="tamanho" data-th-field="*{tamanho}" class="form-control"/>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="lote" class="form-label mb-1">Lote</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="lote"></div>
                                    <input type="text" id="lote" data-th-field="*{lote}" class="form-control"/>
                                </div>
                            </div>

                            <!-- Linha 4: Datas e Qtd 4x3 -->
                            <div class="col-md-3">
                                <label for="fabricacao" class="form-label mb-1">Fabricação</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="fabricacao"></div>
                                    <input type="date" id="fabricacao" data-th-field="*{fabricacao}" class="form-control"/>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="validade" class="form-label mb-1">Validade</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="validade"></div>
                                    <input type="date" id="validade" data-th-field="*{validade}" class="form-control"/>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="referencia" class="form-label mb-1">Referência</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="referencia"></div>
                                    <input type="text" id="referencia" data-th-field="*{referencia}" class="form-control"/>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="quantidade" class="form-label mb-1">Qtd. Amostra</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="quantidade"></div>
                                    <input type="number" id="quantidade" data-th-field="*{quantidade}" class="form-control"/>
                                </div>
                            </div>

                            <!-- Forma Avaliação -->
                            <div class="col-md-12">
                                <label for="formaAvaliacao" class="form-label mb-1">Forma de Avaliação</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="formaAvaliacao"></div>
                                    <input type="text" id="formaAvaliacao" data-th-field="*{formaAvaliacao}" class="form-control"/>
                                </div>
                            </div>
                            
                            <!-- Enviado e Responsável -->
                            <div class="col-md-6">
                                <label for="enviadoPara" class="form-label mb-1">Enviado Para (Setor)</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="enviadoPara"></div>
                                    <input type="text" id="enviadoPara" data-th-field="*{enviadoPara}" class="form-control"/>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="responsavel" class="form-label mb-1">Responsável</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="responsavel"></div>
                                    <input type="text" id="responsavel" data-th-field="*{responsavel}" class="form-control"/>
                                </div>
                            </div>
                            
                             <!-- NOVA LINHA: Data Envio e CHECKBOX DE DOWNLOAD -->
                             <div class="col-md-3">
                                <label for="dataEnvio" class="form-label mb-1">Data Envio</label>
                                <div class="input-group">
                                    <div class="input-group-text" title="Travar campo"><input class="form-check-input mt-0 lock-checkbox" type="checkbox" data-lock-target="dataEnvio"></div>
                                    <input type="date" id="dataEnvio" data-th-field="*{dataEnvio}" class="form-control"/>
                                </div>
                            </div>
                            <div class="col-md-5 d-flex align-items-end">
                                <div class="form-check mb-1 w-100 p-2 rounded checkbox-highlight d-flex align-items-center">
                                    <!-- Campo nome="baixarAgora" enviado ao controller -->
                                    <input class="form-check-input ms-1 me-2 mt-0" type="checkbox" name="baixarAgora" id="baixarAgora">
                                    <label class="form-check-label fw-bold text-primary mb-0" for="baixarAgora" style="cursor: pointer; user-select: none;">
                                        <i class="bi bi-download me-1"></i> Baixar Ficha após Salvar?
                                    </label>
                                </div>
                            </div>
                            
                        </div> <!-- fim da row -->

                        <hr class="my-4">
                        <button id="saveButton" type="submit" class="w-100 btn btn-success btn-lg fw-bold shadow-sm">
                            <i class="bi bi-check-circle-fill"></i> Salvar Ficha
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- COLUNA DIREITA: LATERAIS -->
        <div class="col-lg-3 d-flex flex-column">
            <!-- Painel Pregões -->
            <div class="card shadow-sm mb-3 flex-grow-1">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="my-1 text-primary">Pregões</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalPregao"><i class="bi bi-plus-lg"></i> Novo</button>
                </div>
                <div class="card-body d-flex flex-column p-2">
                    <input type="search" id="searchPregao" class="form-control form-control-sm mb-2" placeholder="Buscar pregão..."
                           name="termoBusca" data-hx-get="/pregoes/buscar" data-hx-trigger="keyup changed delay:500ms" data-hx-target="#pregao-list-container">
                    
                    <div id="pregao-list-container" class="list-group list-group-flush overflow-auto" style="max-height: 250px;">
                        <button type="button" class="list-group-item list-group-item-action" 
                                data-th-each="pregao : ${listaPregoes}"
                                onclick="selecionarPregao(this.getAttribute('data-nome'), this.getAttribute('data-processo'), this.getAttribute('data-descricao'))"
                                data-th-attr="data-nome=${pregao.nome}, data-processo=${pregao.processo}, data-descricao=${pregao.descricao}">
                            <div class="d-flex w-100 justify-content-between"><h6 class="mb-1 fw-bold text-primary" data-th-text="${pregao.nome}"></h6></div>
                            <p class="mb-1 small text-truncate" data-th-text="${pregao.descricao}"></p>
                            <small class="text-muted" data-th-text="'Proc: ' + ${pregao.processo}"></small>
                        </button>
                        <div data-th-if="${listaPregoes.isEmpty()}" class="text-center p-3 text-muted small">Nenhum pregão encontrado.</div>
                    </div>
                </div>
            </div>

            <!-- Painel Empresas -->
            <div class="card shadow-sm mb-5 flex-grow-1">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="my-1 text-secondary">Empresas</h5>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalEmpresa"><i class="bi bi-plus-lg"></i> Nova</button>
                </div>
                <div class="card-body d-flex flex-column p-2">
                    <input type="search" id="searchEmpresa" class="form-control form-control-sm mb-2" placeholder="Buscar empresa..."
                           name="termoBusca" data-hx-get="/empresas/buscar" data-hx-trigger="keyup changed delay:500ms" data-hx-target="#empresa-list-container">
                    <div id="empresa-list-container" class="list-group list-group-flush overflow-auto" style="max-height: 250px;">
                         <button type="button" class="list-group-item list-group-item-action" 
                                data-th-each="empresa : ${listaEmpresas}"
                                onclick="selecionarEmpresa(this.getAttribute('data-nome'))"
                                data-th-attr="data-nome=${empresa.nome}">
                            <h6 class="mb-1 fw-bold text-dark" data-th-text="${empresa.nome}"></h6>
                            <small class="text-muted d-block" data-th-text="${empresa.cnpj != null ? 'CNPJ: ' + empresa.cnpj : '-'}"></small>
                        </button>
                         <div data-th-if="${listaEmpresas.isEmpty()}" class="text-center p-3 text-muted small">Nenhuma empresa encontrada.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAIS (Pregão e Empresa) -->
    <div class="modal fade" id="modalPregao" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white"><h5 class="modal-title">Cadastrar Novo Pregão</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="formNewPregao" data-hx-post="/pregoes/salvar" data-hx-swap="none">
                        <div class="mb-3"><label class="form-label fw-bold">Número do Pregão *</label><input type="text" class="form-control" name="nome" required></div>
                        <div class="mb-3"><label class="form-label fw-bold">Descrição *</label><input type="text" class="form-control" name="descricao" required></div>
                        <div class="mb-3"><label class="form-label fw-bold">Número do Processo *</label><input type="text" class="form-control" name="processo" required></div>
                        <div class="text-end"><button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEmpresa" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white"><h5 class="modal-title">Cadastrar Nova Empresa</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="formNewEmpresa" data-hx-post="/empresas/salvar" data-hx-swap="none">
                        <div class="mb-3"><label class="form-label fw-bold">Razão Social / Nome *</label><input type="text" class="form-control" name="nome" required></div>
                        <div class="mb-3"><label class="form-label fw-bold">CNPJ</label><input type="text" class="form-control" name="cnpj"></div>
                        <div class="text-end"><button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-secondary">Salvar</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // Funções de Seleção
        function selecionarPregao(numero, processo, descricao) {
            const masterCheck = document.getElementById('lockPregaoGroup');
            if (!masterCheck || !masterCheck.checked) {
                document.getElementById('pregao').value = numero || '';
                document.getElementById('processo').value = processo || '';
                document.getElementById('nomePregao').value = descricao || '';
            }
        }

        function selecionarEmpresa(nome) {
            const licitanteCheck = document.querySelector('.lock-checkbox[data-lock-target="licitante"]');
            if (licitanteCheck && !licitanteCheck.checked) {
                document.getElementById('licitante').value = nome || '';
            }
        }

        // HTMX - Fechar Modais
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.elt.id === 'formNewPregao' && evt.detail.successful) {
                evt.detail.elt.reset();
                bootstrap.Modal.getInstance(document.getElementById('modalPregao')).hide();
                htmx.trigger('#searchPregao', 'keyup'); 
            }
            if (evt.detail.elt.id === 'formNewEmpresa' && evt.detail.successful) {
                evt.detail.elt.reset();
                bootstrap.Modal.getInstance(document.getElementById('modalEmpresa')).hide();
                htmx.trigger('#searchEmpresa', 'keyup'); 
            }
        });
        
        // Sistema de Trava (Persistência)
        const formFicha = document.getElementById('fichaForm');
        if (formFicha) {
            formFicha.addEventListener('submit', function() {
                const state = {
                    masterLock: document.getElementById('lockPregaoGroup').checked,
                    lockedFields: {},
                    baixarChecked: document.getElementById('baixarAgora').checked // Lembrar do estado do botão de baixar
                };
                state.valoresHeader = {
                    pregao: document.getElementById('pregao').value,
                    processo: document.getElementById('processo').value,
                    nomePregao: document.getElementById('nomePregao').value
                };
                document.querySelectorAll('.lock-checkbox:checked').forEach(el => {
                    const targetId = el.getAttribute('data-lock-target');
                    const inputEl = document.getElementById(targetId);
                    if(inputEl) state.lockedFields[targetId] = inputEl.value;
                });
                sessionStorage.setItem('fichaFormState', JSON.stringify(state));
            });
        }
        
        // Restaurar Estado
        (function restaurarEstado() {
            const savedRaw = sessionStorage.getItem('fichaFormState');
            if(savedRaw) {
                const saved = JSON.parse(savedRaw);
                if(saved.masterLock) {
                    document.getElementById('lockPregaoGroup').checked = true;
                    document.getElementById('pregao').value = saved.valoresHeader.pregao || '';
                    document.getElementById('processo').value = saved.valoresHeader.processo || '';
                    document.getElementById('nomePregao').value = saved.valoresHeader.nomePregao || '';
                }
                if(saved.baixarChecked) {
                    document.getElementById('baixarAgora').checked = true;
                }
                if(saved.lockedFields) {
                    for (const [fieldId, value] of Object.entries(saved.lockedFields)) {
                        const targetInput = document.getElementById(fieldId);
                        const targetCheckbox = document.querySelector(`.lock-checkbox[data-lock-target="${fieldId}"]`);
                        if(targetInput && targetCheckbox) {
                            targetInput.value = value;
                            targetCheckbox.checked = true;
                        }
                    }
                }
            }
        })();
    </script>

</div> 
</body>
</html>